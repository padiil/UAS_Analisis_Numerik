<!DOCTYPE html>
<html>
  <head>
    <title>Prediksi Pertumbuhan PDRB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      /* Pastikan garis D3.js tidak memiliki fill */
      .line {
        fill: none;
      }
      .line-predicted {
        fill: none;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-900">
    <div
      class="container mx-auto p-6 bg-white shadow-lg rounded-lg mt-10 mb-10"
    >
      <h1 class="text-3xl font-bold text-center mb-8 text-blue-700">
        Prediksi Pertumbuhan PDRB Provinsi di Indonesia
      </h1>

      <form method="POST" class="text-center mb-8">
        <button
          type="submit"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300"
        >
          Lihat Prediksi
        </button>
      </form>

      {% if predictions %}
      <div class="graph-container mb-10 p-6 bg-white shadow-md rounded-lg">
        <h2 class="text-2xl font-semibold border-b-2 pb-3 mb-6 text-gray-800">
          Prediksi Nasional
        </h2>
        <div id="national-graph" class="w-full h-96"></div>
        <h3 class="text-xl font-medium mt-8 mb-4 text-gray-700">
          Tabel Prediksi Nasional
        </h3>
        <table
          class="min-w-full bg-white border border-gray-300 rounded-lg overflow-hidden"
        >
          <thead>
            <tr class="bg-blue-600 text-white">
              <th class="py-3 px-4 text-left">Tahun</th>
              <th class="py-3 px-4 text-left">Prediksi Pertumbuhan (%)</th>
            </tr>
          </thead>
          <tbody>
            {% for year, prediction in predictions.Nasional %}
            <tr class="border-b border-gray-200">
              <td class="py-3 px-4">{{ year }}</td>
              <td class="py-3 px-4">{{ "%.2f" | format(prediction) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <h2 class="text-2xl font-semibold border-b-2 pb-3 mb-6 text-gray-800">
        Prediksi per Provinsi
      </h2>
      <div id="provincial-graphs" class="grid grid-cols-1 md:grid-cols-2 gap-8">
        {% for provinsi, preds in predictions.items() %} {% if provinsi !=
        'Nasional' %}
        <div class="graph-container p-6 bg-white shadow-md rounded-lg">
          <h3 class="text-xl font-medium mb-4 text-gray-700">{{ provinsi }}</h3>
          <div id="graph-{{ loop.index }}" class="w-full h-80"></div>
          <h4 class="text-lg font-medium mt-6 mb-3 text-gray-600">
            Tabel Prediksi {{ provinsi }}
          </h4>
          <table
            class="min-w-full bg-white border border-gray-300 rounded-lg overflow-hidden"
          >
            <thead>
              <tr class="bg-blue-600 text-white">
                <th class="py-3 px-4 text-left">Tahun</th>
                <th class="py-3 px-4 text-left">Prediksi Pertumbuhan (%)</th>
              </tr>
            </thead>
            <tbody>
              {% for year, prediction in preds %}
              <tr class="border-b border-gray-200">
                <td class="py-3 px-4">{{ year }}</td>
                <td>
                  {% if prediction is string %} {{ prediction }} {% else %} {{
                  "%.2f" | format(prediction) }} {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %} {% endfor %}
      </div>

      <p class="text-center text-gray-600 mt-10 text-sm">
        <strong>Catatan:</strong> Prediksi ini didasarkan pada model regresi
        linier sederhana menggunakan data historis yang tersedia. Akurasi
        prediksi dapat bervariasi.
      </p>

      <script>
        var predictions = {{ predictions | tojson }};
        var pdrb_data = {{ pdrb_data | tojson }};

        var margin = {top: 20, right: 30, bottom: 40, left: 50},
            width = 600 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom;

        function drawGraph(historicalData, predictedData, containerId) {
            // Kosongkan konten container sebelum menggambar grafik baru
            d3.select("#" + containerId).html("");

            var container = d3.select("#" + containerId);
            var containerWidth = container.node().getBoundingClientRect().width;
            var containerHeight = container.node().getBoundingClientRect().height;

            var width = containerWidth - margin.left - margin.right;
            var height = containerHeight - margin.top - margin.bottom;

            var combinedData = historicalData.concat(predictedData);

            if (!combinedData || combinedData.length === 0 || (historicalData.length > 0 && typeof historicalData[0][0] === 'string')) {
                d3.select("#" + containerId).html("<p class='text-red-500 text-center'>Tidak cukup data untuk menampilkan grafik.</p>");
                return;
            }

            var svg = d3.select("#" + containerId)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.bottom + margin.top)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scaleLinear()
                .domain(d3.extent(combinedData, function(d) { return d[0]; }))
                .range([0, width]);
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).tickFormat(d3.format("d")));

            var y = d3.scaleLinear()
                .domain(d3.extent(combinedData, function(d) { return d[1]; }))
                .range([height, 0]);
            svg.append("g")
                .call(d3.axisLeft(y).ticks(5)); // Mengatur jumlah ticks pada sumbu Y

            // Garis Historis
            var lineHistorical = d3.line()
                .x(function(d) { return x(d[0]); })
                .y(function(d) { return y(d[1]); });

            svg.append("path")
                .datum(historicalData)
                .attr("class", "line stroke-blue-500 stroke-2")
                .attr("d", lineHistorical);

            // Garis Prediksi
            var linePredicted = d3.line()
                .x(function(d) { return x(d[0]); })
                .y(function(d) { return y(d[1]); });

            // Temukan tahun terakhir data historis
            var lastHistoricalYear = d3.max(historicalData, function(d) { return d[0]; });

            // Filter data prediksi yang dimulai setelah tahun terakhir data historis
            var filteredPredictedData = predictedData.filter(function(d) {
                return d[0] > lastHistoricalYear;
            });

            // Gabungkan titik terakhir data historis dengan data prediksi
            var combinedPredictedData = [];
            if (historicalData.length > 0) {
                combinedPredictedData.push(historicalData[historicalData.length - 1]);
            }
            combinedPredictedData = combinedPredictedData.concat(filteredPredictedData);

            if (combinedPredictedData.length > 1) {
                svg.append("path")
                    .datum(combinedPredictedData)
                    .attr("class", "line-predicted stroke-orange-500 stroke-2 stroke-dashed")
                    .attr("d", linePredicted);
            }


            // Tooltip
            var tooltip = d3.select("body").append("div")
                .attr("class", "absolute z-10 p-2 text-sm leading-none text-white whitespace-no-wrap bg-gray-800 rounded shadow-md opacity-0 transition-opacity duration-200 pointer-events-none");

            // Titik-titik data historis
            svg.selectAll(".dot-historical")
                .data(historicalData)
                .enter().append("circle")
                .attr("r", 5)
                .attr("cx", function(d) { return x(d[0]); })
                .attr("cy", function(d) { return y(d[1]); })
                .attr("class", "dot fill-blue-500 stroke-white stroke-1.5")
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html("Tahun: " + d[0] + "<br/>Pertumbuhan: " + d3.format(".2f")(d[1]) + "%")
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Titik-titik data prediksi
            svg.selectAll(".dot-predicted")
                .data(filteredPredictedData)
                .enter().append("circle")
                .attr("r", 5)
                .attr("cx", function(d) { return x(d[0]); })
                .attr("cy", function(d) { return y(d[1]); })
                .attr("class", "dot-predicted fill-orange-500 stroke-white stroke-1.5")
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html("Tahun (Prediksi): " + d[0] + "<br/>Pertumbuhan: " + d3.format(".2f")(d[1]) + "%")
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Label Sumbu X
            svg.append("text")
                .attr("transform", "translate(" + (width/2) + " ," + (height + margin.top + 20) + ")")
                .attr("class", "text-gray-600 text-sm")
                .style("text-anchor", "middle")
                .text("Tahun");

            // Label Sumbu Y
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .attr("class", "text-gray-600 text-sm")
                .style("text-anchor", "middle")
                .text("Pertumbuhan (%)");
        }

        // Gambar grafik nasional
        if (predictions && predictions.Nasional && pdrb_data && pdrb_data.Nasional) {
            drawGraph(pdrb_data.Nasional, predictions.Nasional, "national-graph");
        }

        // Gambar grafik per provinsi
        if (predictions && pdrb_data) {
            var i = 1; // Mulai dari 1 karena loop.index di Jinja2 mulai dari 1
            for (var provinsi in predictions) {
                if (provinsi !== 'Nasional' && pdrb_data[provinsi]) {
                    var containerId = "graph-" + i;
                    drawGraph(pdrb_data[provinsi], predictions[provinsi], containerId);
                    i++; // Tingkatkan counter untuk provinsi berikutnya
                }
            }
        }
      </script>
      {% endif %}
    </div>
  </body>
</html>
